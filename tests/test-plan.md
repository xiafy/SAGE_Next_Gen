# TEST_PLAN.md — 测试策略

> 原则：**测试和开发分离**。测试用例由独立 QA Agent 编写和执行，不由开发 Agent 自测。  
> 历史教训：开发者自测会写出 `expect(true).toBe(true)` 这种自欺欺人的测试。

---

## 测试哲学

1. **场景驱动** — 从真实用餐场景出发设计用例，不是从代码结构出发
2. **破坏性思维** — 每个功能先想"怎么让它出错"，再想"正常路径"
3. **边界优先** — 正常 case 很少 Bug，边界 case 才是 Bug 的温床
4. **真机验证** — Scanner 等涉及硬件的功能只有真机才算验证

---

## 测试分层

### L1 — 单元测试（Unit Tests）
**工具**: Vitest  
**覆盖目标**: 工具函数、数据处理、菜单解析逻辑  
**标准**: > 80% 覆盖率

### L2 — 组件测试（Component Tests）
**工具**: Vitest + @testing-library/react  
**覆盖目标**: 核心 UI 组件行为  
**标准**: 核心组件 100% 覆盖

### L3 — 集成测试（Integration Tests）
**工具**: Vitest + MSW（Mock Service Worker）  
**覆盖目标**: API 调用链路、AI 返回处理  
**标准**: 所有 API 接口有 Mock 测试

### L4 — 端到端测试（E2E）
**工具**: Playwright  
**覆盖目标**: 核心用户旅程  
**标准**: 核心旅程 100% 覆盖，边界场景 60%+

### L5 — 真机测试（Manual）
**执行**: Mr. Xia 或指定测试人员  
**覆盖目标**: Scanner 摄像头、GPS、真实菜单识别  
**标准**: MVP Alpha 前完成一轮

---

## 核心测试场景（来自历史 QA 经验）

### 场景类型一：用户行为不确定性

| # | 场景 | 测试要点 |
|---|------|---------|
| U1 | 用户发了空消息 | 不 crash，有友好提示 |
| U2 | 用户连续快速点击发送 | 防抖，不重复发送 |
| U3 | 用户在 AI 响应前发第二条消息 | 消息队列正确处理 |
| U4 | 用户切换到探索视图再返回 | 对话历史不丢失 |
| U5 | 用户多次补充菜单 | 菜单合并正确，不重复 |

### 场景类型二：菜单数据多样性

| # | 场景 | 测试要点 |
|---|------|---------|
| M1 | 中文菜单（标准格式）| 基准测试 |
| M2 | 英文菜单（西餐）| 多语言基础 |
| M3 | 日文菜单（含汉字）| CJK 字符处理 |
| M4 | 泰文菜单（含泰铢 ฿）| 货币符号解析 |
| M5 | 阿拉伯文菜单（RTL）| 方向性文字 |
| M6 | 手写菜单 / 黑板菜单 | 低质量图片识别 |
| M7 | 多页菜单（补充拍摄）| mergeMenus 逻辑 |
| M8 | 酒单（皮质精装）| 动态角色=侍酒师 |
| M9 | 甜品菜单 | 动态角色=甜品专家 |
| M10 | 图片菜单（有实物照片）| 图文结合识别 |
| M11 | 套餐规则型菜单（每排选一）| 游戏规则理解 |
| M12 | 极简菜单（只有菜名无描述）| 最少信息场景 |

### 场景类型三：技术边界

| # | 场景 | 测试要点 |
|---|------|---------|
| T1 | 网络断开时拍照 | 优雅错误提示，不 crash |
| T2 | AI API 超时（> 15s）| 超时处理，显示重试 |
| T3 | AI 返回非 JSON | zod 校验兜底，降级到本地 |
| T4 | 本地存储满（5MB）| 不 crash，清理旧数据 |
| T5 | 极大菜单（> 100 道菜）| 性能不卡顿 |
| T6 | 摄像头权限被拒绝 | 引导开启权限，有替代方案 |
| T7 | 低端设备（2GB RAM）| 不 OOM |

### 场景类型四：安全测试

| # | 场景 | 测试要点 |
|---|------|---------|
| S1 | XSS 注入（菜名含 HTML）| 输出被 sanitize |
| S2 | API Key 是否泄露前端 | 构建产物中不含 Key |
| S3 | CORS 配置 | 非白名单域名请求被拒绝 |
| S4 | 速率限制 | 同一用户高频请求被限流 |

---

## 质量门（Quality Gates）

在进入下一 Sprint 前必须达到的标准：

### Sprint 0 → Sprint 1（进入写代码阶段前）
- [ ] 所有文档写完，经 Mr. Xia 确认
- [ ] CLAUDE.md 被至少一个新 Agent 读取后能独立执行

### Sprint 1 → Sprint 2（Alpha → 接入感知）
- [ ] `pnpm build` 零错误零警告
- [ ] L1/L2 测试全部通过
- [ ] 无 API Key 前端暴露
- [ ] 真机 Scanner 基础流程跑通

### Sprint 2 → Sprint 3（Beta → 上线准备）
- [ ] L1-L4 全部测试通过
- [ ] 场景矩阵（M1-M12）全部测试
- [ ] 安全测试（S1-S4）全部通过
- [ ] 性能：首屏 < 2s，菜单识别等待有进度反馈

### Sprint 3 → 上线
- [ ] Mr. Xia 真机验收通过
- [ ] 无 P0/P1 Bug
- [ ] 错误监控配置完成
