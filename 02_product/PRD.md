# PRD — 产品需求文档

> 版本: v1.4
> 日期: 2026-02-26
> 状态: 🟢 F01-F10 全部对齐；Pre-Chat 机制升级（DEC-027）
> 上游文档: `01_strategy/VISION.md v1.1`

---

## 0. 阅读指引

本文档定义 SAGE Next Gen 的**MVP 功能规格**。

- 功能优先级标签：`[MVP]` / `[Sprint 2]` / `[Future]`
- 每个功能模块包含：用户目标、功能描述、验收标准（AC）
- 技术实现细节不在本文档，见 `04_technical/`

---

## 1. 产品概述

SAGE 是面向全球旅行者的餐饮智能体。

**核心价值主张**：在菜单超过 30% 是非母语的陌生餐厅，帮用户通过 ≤3 轮 AI 对话完成点餐决策。

**MVP 范围**：
- 用户群：中国旅行者 + 英语系欧美旅行者
- 形态：手机 Web App，无需下载，无需登录
- 语言：中英双语 UI（系统语言自动切换 + 支持手动切换）
- **用户路径：实现 Path A（主路径）+ Path C（补充菜单）**
- Path B（随便聊聊）移入 Backlog，MVP 不实现

---

## 2. 用户画像

### Persona A：阿明（中国旅行者）
- **背景**：30 岁，上海互联网从业者，每年出境 3-4 次（日韩东南亚为主）
- **场景**：在曼谷夜市，菜单全是泰文
- **现有行为**：拍照发给 ChatGPT 翻译，但要来回切换 App，且只能翻译不能推荐
- **核心诉求**：先看全量菜单有个大致了解，再让 AI 推荐
- **痛点**：翻译工具只翻译，不推荐；通用 AI 步骤多；不懂菜单规则导致尴尬
- **设备**：iPhone，微信重度用户，不愿安装新 App

### Persona B：Sarah（美国旅行者）
- **背景**：28 岁，纽约设计师，第一次去日本旅行
- **场景**：在东京居酒屋，菜单全是日文，服务员英语有限
- **现有行为**：用 Google Lens 翻译，不知道菜是什么样、适不适合自己
- **核心诉求**：了解菜品文化背景，避免踩雷（过敏、口味不合）
- **痛点**：不了解日本饮食文化；担心点到不能吃的东西
- **设备**：Android，Safari/Chrome 用户

---

## 3. 核心用户旅程

### 旅程 A：扫描菜单路径（主路径）`[MVP]`

```
[进入 App]
    ↓ GPS 授权请求（立即，静默）
[Home]
    ↓ 点击「扫描菜单」
[Scanner 全屏相机页面]
    ├─ 拍照（支持连续拍摄多张）
    ├─ 从相册选择
    └─ 预览 / 删除 / 确认（最多 5 张）
         ↓ 确认发送，立即跳转
[AgentChat]
    ├─ Icebreaker（AI 先问：几位？有忌口？）
    ├─ 菜单识别完成 → AI 开场介绍 + 推荐
    └─ 用户对话 → 查看全量菜单 → 加入点餐单
         ↓
[点餐单] → [展示给服务员]
```

### 旅程 B：直接对话 `[Backlog — MVP 不实现]`

> 场景：在路上问"泰国菜我该注意什么"等。MVP 后规划。

### 旅程 C：补充菜单路径 `[MVP]`

```
[AgentChat 进行中]
    ↓ 点击「📷 补充菜单」
[Scanner 全屏相机页面]（同 Path A）
    ↓ 拍摄酒单 / 甜品单 / 套餐规则页
[AgentChat]
    └─ AI 自动合并菜单，提示新增内容，继续对话
```

---

## 4. 功能规格

---

### F01 — Home

**用户目标**：打开 App 立即看到入口，1 秒内开始操作。

**功能描述**：
- 主入口：「📷 扫描菜单」（大按钮，视觉焦点）
- 右上角：「⚙️ 设置」图标（进入偏好管理 + 语言切换）
- 动态问候语（基于时段：早安 / 午好 / 晚好 / 深夜好）
- **不显示历史记录**（历史偏好由 AI 在对话中自然提及）
- 无注册/登录引导，打开即用

**验收标准**：
- AC1: 首屏可交互 < 2 秒（4G 网络）
- AC2: 主入口在 375px-430px 屏宽下清晰可见，无需滚动
- AC3: 语言根据系统语言自动显示
- AC4: 设置图标可访问，点击进入设置页

**优先级**：`[MVP]`

---

### F02 — Scanner（全屏相机页面）

**用户目标**：快速完成菜单拍摄，支持多张，可删除重拍，体验流畅。

**功能描述**：
- **独立全屏页面**（不是底部弹层）
- 进入后默认激活相机
- 顶部：已拍张数显示 + 关闭按钮
- 底部操作区：
  - 快门按钮（拍照）
  - 相册按钮（选择已有照片）
  - 缩略图预览条（已选图片，可点击删除）
- 支持最多 **5 张**图片
- 「确认」按钮：确认后关闭 Scanner，跳转 AgentChat 并开始上传识别
- **两个入口**：
  1. Home「扫描菜单」按钮（首次进入，Path A）
  2. AgentChat 内「📷 补充菜单」按钮（对话中途，Path C）

**验收标准**：
- AC1: 从 Home 点击到 Scanner 相机激活 < 2 秒
- AC2: 支持 JPG / PNG / HEIC 格式
- AC3: 最多 5 张，超过时禁用快门并提示
- AC4: 已选图片显示缩略图，可单张删除
- AC5: 相机权限被拒时显示引导说明，相册入口仍可用
- AC6: 图片上传前压缩至 < 2MB（不影响识别质量）
- AC7: Path C 进入时保持 AgentChat 对话历史，返回后可继续对话

**优先级**：`[MVP]`

---

### F03 — 菜单识别（AI Vision）

**用户目标**：AI 准确理解菜单内容，为对话和推荐提供基础。

**功能描述**：
- 调用 AI Vision API 识别菜单图片（OQ3 决定具体模型）
- 多张图片合并识别，按类别整合，重复菜品去重
- 提取内容：菜品名称（原文 + 翻译）、价格、描述、分类、食材关键词、过敏原信号
- 同时输出：`detectedLanguage`、`priceLevel`（1-3 档）
- 识别过程中 AgentChat 不阻塞，显示 Icebreaker 对话

**识别失败处理**：
- 图片模糊 → 提示"图片有点模糊，建议重新拍一张，光线好一点更准"+ 「重新拍摄」按钮
- 语言暂不支持 → 提示"这个语言我暂时识别不好，建议换张更清晰的图或换个角度"
- 网络/API 异常 → 提示"网络好像有点问题，稍后再试试"+ 「重试」按钮
- **不引导用户手动输入菜单**（输入法问题 + 失去使用 SAGE 的意义）

**验收标准**：
- AC1: 支持语言：中 / 英 / 日 / 韩 / 泰 / 法 / 西班牙 / 意大利 / 德语
- AC2: 标准印刷菜单识别成功率 ≥ 90%
- AC3: 识别时间 < 10 秒（P90，正常网络）
- AC4: 所有 AI 返回数据经 zod schema 校验，校验失败时有降级处理
- AC5: 失败提示引导用户重新拍摄，不出现技术错误信息

**优先级**：`[MVP]`

---

### F04 — 4+1 维感知数据采集

**用户目标**：AI 理解我当下的完整场景，不只是菜单内容。

#### F04-A 时间感知 `[MVP]`
- 自动读取系统时间，注入 AI 上下文
- 时段映射：07-10 早餐 / 11-14 午餐 / 17-21 晚餐 / 21+ 夜宵

#### F04-B 空间感知 `[MVP]`
- 进入 App 时立即请求 GPS 授权
- 权限被拒：**静默跳过，不显示任何提示**，AI 推荐不考虑位置维度
- 权限通过：获取大致区域（城市级），注入 AI 上下文

#### F04-C 天气感知 `[Sprint 2]`
- 依赖 GPS，Sprint 2 实现

#### F04-D 历史记忆 `[MVP]`
- localStorage 持久化用户偏好
- 下次打开时注入 AI 上下文，AI 自然融入，不机械念清单

**验收标准**：
- AC1: 所有感知数据采集失败时，主流程不中断
- AC2: GPS 被拒后无任何弹窗或提示
- AC3: 历史记忆跨 session 持久（同浏览器/设备）

**优先级**：`[MVP]`

---

### ~~F05 — 动态 AI 角色系统~~ `[已删除]`

> **决策（DEC-020）**：该功能为伪需求，整体移除。
> AI 使用统一的餐饮助手身份，不需要根据菜单类型切换角色。
> 菜单识别不再输出 `agentRole` / `agentGreeting` 字段。

---

### F06 — AgentChat 对话界面

**用户目标**：通过自然对话快速完成点餐决策，≤3 轮。

**功能描述**：

**Pre-Chat 机制（DEC-027，升级自 Icebreaker）**：
- 图片确认后立即跳转 AgentChat，不等识别完成
- AI 立即发出第一条消息（本地生成，毫秒出现），随即进入 **Pre-Chat 模式**
- Pre-Chat 模式：AI（Qwen3.5-Flash）**主动多轮引导**用户说出需求，而非静态等待
  - 每轮只问一件事：用餐人数→忌口→口味偏好→今日心情…
  - 对话自然、像朋友问候，不像问卷填写
  - AI 随时从对话中提炼偏好（inline preferenceUpdates）
- 识别完成时（HANDING_OFF）：
  - 将全量 Pre-Chat 对话历史 + 已提炼偏好 + 菜单数据，一并喂给主 Chat AI（Qwen3.5-Plus）
  - 主 Chat AI **不重复问已回答的问题**，直接基于完整信息给出推荐
  - 用户感知：AI 第一条正式消息就精准切中需求

**对话界面**：
- 消息气泡（AI / 用户，区分视觉）
- AI 快捷回复按钮（每次回复后动态生成 2-4 个，非固定）
- 菜品推荐以**垂直紧凑列表**内嵌在对话流中（非横滑大卡片）
- 推荐卡片：原文菜名 + 翻译 + 价格 + 一句话描述 + 「➕ 加入」按钮
- 底部输入栏含「📷 补充菜单」按钮（Path C 入口）
- 「📋 查看全部菜单」入口（进入 F07 探索视图）

**验收标准**：
- AC1: Pre-Chat 第一条消息在进入 AgentChat 后 < 1 秒出现（本地生成）
- AC2: Pre-Chat 阶段 AI 响应 < 1.5 秒（Qwen3.5-Flash）
- AC3: 菜单识别完成后主 Chat 首条消息 < 5 秒（P90）
- AC4: 主 Chat 首条消息不重复询问 Pre-Chat 已回答的问题
- AC5: 快捷按钮由 AI 根据上下文动态生成
- AC6: 切换到探索视图再返回，对话历史完整保留
- AC7: 网络中断时，已有对话不丢失

**优先级**：`[MVP]`

---

### F07 — 菜品探索视图（全量菜单）

**用户目标**：在 AI 推荐之外，能自己浏览完整菜单，有整体认知。

**背景**：部分用户习惯先看全量菜单再做决策（符合 Mr. Xia 本人习惯）。该功能可提升初次使用信任度，同时解决语言障碍。**上线后计划做 A/B Test 验证该入口的使用率与转化影响。**

**功能描述**：
- 从 AgentChat「📋 查看全部菜单」进入
- 展示所有菜品（按 AI 识别分类），双语显示
- 每道菜：原文菜名 + 翻译 + 价格 + 简短描述
- 点击展开详情（食材 / 过敏原 / AI 文化注解）
- 每道菜有「➕ 加入点餐单」按钮
- 「← 返回对话」按钮随时可返回 AgentChat

**验收标准**：
- AC1: 探索视图内操作不丢失 AgentChat 对话历史
- AC2: 菜品分类由 AI 识别决定，不硬编码
- AC3: 返回 AgentChat 时定位到最新消息

**优先级**：`[MVP]`
**A/B Test 计划**：上线后测试「有探索视图」vs「无探索视图」对最终下单率和会话满意度的影响。

---

### F08 — 点餐单与展示模式

**用户目标**：整理好点的菜，展示给服务员。

**功能描述**：
- 底部浮动点餐单入口（有菜品时出现，显示数量 + 总价）
- 点餐单页面：菜品列表 + 数量调整（+/-）+ 删除 + 小计
- **展示给服务员模式**：全屏大字，只显示原文菜名 + 数量，屏幕常亮
- 货币符号自动适配（¥ / $ / € / ฿ 等）

**验收标准**：
- AC1: 数量变化时总价实时更新
- AC2: 展示模式字号 ≥ 28px，高对比（深色背景白字）
- AC3: 展示模式只显示原文菜名，不显示翻译
- AC4: 展示模式屏幕常亮（navigator.wakeLock，不可用时降级提示）

**优先级**：`[MVP]`

> **小费建议**：MVP 不实现。美国市场推广时列为高优先级需求（见 Sprint 2）。

---

### F09 — 偏好管理

**用户目标**：SAGE 记住我的饮食习惯；我能查看和编辑已记录的偏好。

**功能描述**：

**自动学习（后台）**：
- AI 从对话中识别偏好信号并存储
- 偏好类型：忌口 / 过敏原 / 口味倾向 / 饮食限制（素食/清真/无麸质）
- 下次 session 时 AI 自然融入已知偏好

**偏好管理页（参考 ChatGPT 个性化设置风格）**：
- 入口：Home 右上角「⚙️ 设置」→ 偏好管理
- 显示已记录的偏好列表（每条可单独删除）
- 用户可手动添加偏好
- 「清空全部」选项

**验收标准**：
- AC1: 偏好持久化存储，跨 session 有效
- AC2: AI 提及偏好的方式自然，不机械念清单
- AC3: 偏好管理页可查看 / 删除 / 添加每条偏好
- AC4: 用户在对话中说"其实我现在可以吃香菜了"，AI 更新记录

**优先级**：`[MVP]`

---

### F10 — 语言切换

**用户目标**：界面语言符合我的习惯，支持手动调整。

**功能描述**：
- 默认：系统语言自动检测（中文系统→中文，其他→英文）
- 手动切换入口：Home 右上角「⚙️ 设置」→ 语言设置
- 切换后全局生效，持久保存

**验收标准**：
- AC1: 自动检测准确（中文/非中文两档）
- AC2: 手动切换后全部 UI 文案更新，无遗漏
- AC3: 语言设置跨 session 持久

**优先级**：`[MVP]`

---

## 5. 设置页（Settings）

**入口**：Home 右上角「⚙️」图标

**包含**：
| 选项 | 功能 |
|------|------|
| 偏好管理 | 查看 / 编辑 / 删除 / 添加饮食偏好 |
| 语言设置 | 中文 / English 手动切换 |

> MVP 设置页保持极简，不加其他选项。

---

## 6. 非功能性需求

| 类别 | 要求 |
|------|------|
| **性能** | 首屏可交互 < 2s（4G）；Icebreaker < 1s；AI 推荐 < 5s（P90）|
| **可用性** | iOS Safari 16+，Android Chrome 100+；桌面显示友好提示 |
| **安全** | AI API Key 仅在 Cloudflare Worker；前端零 Key |
| **隐私** | 菜单图片不持久存储；用户偏好仅存本地 localStorage |
| **离线** | 核心 UI 可离线加载；AI 功能需网络，无网显示友好提示 |
| **国际化** | UI 中英双语；菜单识别支持 9 种核心语言 |

---

## 7. 不在 MVP 范围

| 功能 | 原因 |
|------|------|
| Path B 随便聊聊 | 先验证核心场景 |
| 用户账号/登录 | 增加摩擦，MVP 不需要 |
| 云端记忆同步 | 本地存储足够验证价值 |
| 餐厅推荐/搜索 | 用户已在餐厅 |
| 小费建议 | 延至美国市场 Sprint |
| 用餐后评价 | 反馈闭环是第二阶段 |
| 动态 AI 角色系统 | 伪需求，已删除（DEC-020）|
| 原生 App | Web 足以验证 |
| 天气感知 | Sprint 2 |

---

## 8. 功能优先级矩阵

| 功能 | 优先级 | 依赖 |
|------|--------|------|
| F01 Home | 🔴 MVP | 无 |
| F10 语言切换（设置页）| 🔴 MVP | F01 |
| F09 偏好管理（设置页）| 🔴 MVP | F01 |
| F02 Scanner | 🔴 MVP | F01 |
| F03 菜单识别 | 🔴 MVP | F02 |
| F06 AgentChat | 🔴 MVP | F03 |
| F04-A 时间感知 | 🔴 MVP | F06 |
| F04-B 空间感知 | 🔴 MVP | F06 |
| F04-D 历史记忆 | 🔴 MVP | F06 |
| F07 探索视图 | 🔴 MVP | F03 |
| F08 点餐单 | 🔴 MVP | F06 |
| Path C 补充菜单 | 🔴 MVP | F02、F06 |
| F04-C 天气感知 | 🟢 Sprint 2 | F04-B |
| 小费建议 | 🟢 Sprint 2（美国市场）| F08 |

---

## 9. 开放问题

| # | 问题 | 影响 | 优先级 | 状态 |
|---|------|------|--------|------|
| OQ1 | 免费试用次数 X = 多少？ | 定价策略 | Sprint 2 前 | ⏳ 待决策 |
| OQ3 | Vision 模型选型 | 识别质量/成本 | Sprint 1 技术选型 | ✅ DEC-026：Qwen3-VL-Plus/Flash |
| OQ4 | 5 张图同时提交还是逐张？ | API 成本/体验 | Sprint 1 技术选型 | ✅ DEC-026：同时提交，content array |
