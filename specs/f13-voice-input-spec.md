# Spec â€” F13 è¯­éŸ³è¾“å…¥ï¼ˆVoice Inputï¼‰v2

> ç‰ˆæœ¬: v2.0 | æ—¥æœŸ: 2026-03-01
> å…³è”è§„åˆ™: PRD Â§4.3 F13
> å…³è”å†³ç­–: DEC-039, DEC-041

---

## å˜æ›´æ‘˜è¦ (v1 â†’ v2)

| é¡¹ç›® | v1 | v2 |
|------|----|----|
| è¯†åˆ«å¼•æ“ | Web Speech API (æµè§ˆå™¨ç«¯) | MediaRecorder + æœåŠ¡ç«¯ ASR (DashScope SenseVoice) |
| äº¤äº’æ¨¡å¼ | å°æŒ‰é’® pointerdown/up | **å¾®ä¿¡é£æ ¼**ï¼šé”®ç›˜/è¯­éŸ³åˆ‡æ¢ + å¤§æŒ‰é’®æŒ‰ä½è¯´è¯ |
| å–æ¶ˆæ‰‹åŠ¿ | æ—  | ä¸Šæ»‘å–æ¶ˆ |
| å…¼å®¹æ€§ | ä¾èµ– Google æœåŠ¡å™¨ï¼Œå›½å†…ä¸å¯ç”¨ | MediaRecorder (iOS 14.3+) + è‡ªæœ‰ APIï¼Œå…¨å¹³å°å¯ç”¨ |

---

## ç”¨æˆ·è·¯å¾„

1. è¾“å…¥æ å·¦ä¾§æœ‰ ğŸ¤ åˆ‡æ¢æŒ‰é’®ï¼Œç‚¹å‡»è¿›å…¥è¯­éŸ³æ¨¡å¼
2. æ–‡å­—è¾“å…¥æ¡†å˜ä¸ºå¤§å· **"æŒ‰ä½ è¯´è¯"** æŒ‰é’®
3. **æŒ‰ä½** â†’ å¼€å§‹å½•éŸ³ï¼ŒæŒ‰é’®å˜è‰² + æ˜¾ç¤ºå½•éŸ³æ—¶é•¿
4. **ä¸Šæ»‘** â†’ è¿›å…¥å–æ¶ˆåŒºåŸŸï¼Œæç¤º"æ¾å¼€ å–æ¶ˆ"
5. **æ¾æ‰‹ï¼ˆæœªå–æ¶ˆï¼‰** â†’ éŸ³é¢‘ä¸Šä¼ è½¬å†™ â†’ æ–‡å­—è‡ªåŠ¨å‘é€
6. **æ¾æ‰‹ï¼ˆå·²å–æ¶ˆï¼‰** â†’ ä¸¢å¼ƒå½•éŸ³ï¼Œå›åˆ°å¾…æœº
7. å†æ¬¡ç‚¹å‡» ğŸ¤ æŒ‰é’®ï¼ˆæˆ–ç‚¹ âŒ¨ï¸ æŒ‰é’®ï¼‰åˆ‡å›æ–‡å­—æ¨¡å¼

---

## éªŒæ”¶æ ‡å‡†ï¼ˆACï¼‰

- **AC1**: å¾®ä¿¡é£æ ¼äº¤äº’â€”â€”åˆ‡æ¢æŒ‰é’® + æŒ‰ä½è¯´è¯ + ä¸Šæ»‘å–æ¶ˆ
- **AC2**: å½•éŸ³ä½¿ç”¨ MediaRecorderï¼Œå‹ç¼©éŸ³é¢‘ï¼ˆç›®æ ‡ â‰¤2KB/sï¼‰
- **AC3**: æœåŠ¡ç«¯ ASRï¼ˆDashScope SenseVoiceï¼‰ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡
- **AC4**: è½¬å†™å®Œæˆåè‡ªåŠ¨å‘é€åˆ°å¯¹è¯ï¼ˆæ— éœ€æ‰‹åŠ¨ç¡®è®¤ï¼‰
- **AC5**: å½•éŸ³ä¸­æœ‰è§†è§‰åé¦ˆï¼šæŒ‰é’®å˜è‰² + å½•éŸ³æ—¶é•¿è®¡æ—¶å™¨
- **AC6**: ä¸Šæ»‘ >80px è¿›å…¥å–æ¶ˆåŒºåŸŸï¼Œæ¾æ‰‹å–æ¶ˆå½•éŸ³
- **AC7**: é”™è¯¯å¤„ç†ï¼šéº¦å…‹é£æƒé™æ‹’ç» â†’ Toastï¼›è½¬å†™å¤±è´¥ â†’ Toastï¼›å½•éŸ³æ—¶é•¿ <0.5s â†’ å¿½ç•¥
- **AC8**: MediaRecorder ä¸å¯ç”¨æ—¶ï¼Œåˆ‡æ¢æŒ‰é’®éšè—ï¼ˆé™çº§ä¸ºçº¯æ–‡å­—ï¼‰
- **AC9**: æœ€å¤§å½•éŸ³æ—¶é•¿ 60sï¼Œåˆ°æ—¶è‡ªåŠ¨åœæ­¢å¹¶å‘é€

---

## æŠ€æœ¯æ–¹æ¡ˆ

### éŸ³é¢‘å½•åˆ¶ (Frontend)

```typescript
// ç¼–è§£ç å™¨é€‰æ‹©ï¼ˆä¼˜å…ˆ opusï¼ŒiOS å…œåº• mp4/aacï¼‰
const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
  ? 'audio/webm;codecs=opus'
  : 'audio/mp4';

const recorder = new MediaRecorder(stream, {
  mimeType,
  audioBitsPerSecond: 16_000,  // 16kbps â€” è¯­éŸ³è¶³å¤Ÿæ¸…æ™°
});
```

**å‹ç¼©æ•ˆæœé¢„ä¼°**ï¼š
- 16kbps Ã— 10s = ~20KB
- 16kbps Ã— 30s = ~60KB
- 16kbps Ã— 60s = ~120KB

### æœåŠ¡ç«¯è½¬å†™ (Worker)

```
POST /api/transcribe
Content-Type: application/json

{
  "audio": "<base64 encoded audio>",
  "mimeType": "audio/webm" | "audio/mp4",
  "language": "zh" | "en"
}

Response: { "ok": true, "text": "è½¬å†™æ–‡å­—" }
```

Worker å†…éƒ¨è°ƒç”¨ DashScope OpenAI å…¼å®¹ ASR ç«¯ç‚¹ï¼š
```
POST https://dashscope.aliyuncs.com/compatible-mode/v1/audio/transcriptions
Content-Type: multipart/form-data

file: <audio binary>
model: sensevoice-v1
```

### å¾®ä¿¡é£æ ¼ UI çŠ¶æ€æœº

```
[æ–‡å­—æ¨¡å¼] â†â†’ [è¯­éŸ³æ¨¡å¼(å¾…æœº)]
                    â†“ pointerdown
              [å½•éŸ³ä¸­]
              â†™        â†˜
    æ¾æ‰‹(y>-80)     æ¾æ‰‹(y<-80)
        â†“                â†“
   [è½¬å†™ä¸­...]      [å·²å–æ¶ˆ]
        â†“
   [è‡ªåŠ¨å‘é€]
```

### æŒ‰é’®è§†è§‰çŠ¶æ€

| çŠ¶æ€ | å¤–è§‚ |
|------|------|
| è¯­éŸ³å¾…æœº | ç°è‰²èƒŒæ™¯ "æŒ‰ä½ è¯´è¯" |
| å½•éŸ³ä¸­ | ç»¿è‰²èƒŒæ™¯ "æ¾å¼€ å‘é€" + æ—¶é•¿è®¡æ—¶ |
| å–æ¶ˆåŒºåŸŸ | çº¢è‰²èƒŒæ™¯ "æ¾å¼€ å–æ¶ˆ" |
| è½¬å†™ä¸­ | loading çŠ¶æ€ï¼ŒæŒ‰é’®ç¦ç”¨ |

---

## çº¦æŸ

- éŸ³é¢‘ base64 ä¸Šä¼ ï¼Œå•æ¬¡ â‰¤200KBï¼ˆ60s Ã— 16kbps â‰ˆ 120KB rawï¼‰
- Worker è¶…æ—¶ 15sï¼ˆDashScope ASR é€šå¸¸ <3sï¼‰
- MVP åªåš STTï¼Œä¸åš TTS
- æœ€çŸ­å½•éŸ³ 0.5sï¼Œä½äºæ­¤é˜ˆå€¼é™é»˜ä¸¢å¼ƒ

---

## å½±å“æ–‡ä»¶

- `app/src/views/AgentChatView.tsx` â€” å¾®ä¿¡é£æ ¼è¯­éŸ³ UI + MediaRecorder
- `app/src/api/transcribe.ts` â€” æ–°å¢ï¼šè°ƒç”¨ /api/transcribe
- `worker/handlers/transcribe.ts` â€” æ–°å¢ï¼šéŸ³é¢‘è½¬å†™å¤„ç†
- `worker/index.ts` â€” æ–°å¢è·¯ç”± POST /api/transcribe
- `worker/middleware/cors.ts` â€” Env ç±»å‹æ— éœ€å˜æ›´ï¼ˆå¤ç”¨ BAILIAN_API_KEYï¼‰
